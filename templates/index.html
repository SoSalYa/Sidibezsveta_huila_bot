<!DOCTYPE html>
<html lang="uk">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ü–∞–Ω–µ–ª—å —É–ø—Ä–∞–≤–ª—ñ–Ω–Ω—è –±–æ—Ç–æ–º</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            color: #e0e0e0;
            min-height: 100vh;
        }

        .header {
            background: linear-gradient(135deg, #0f3460 0%, #16213e 100%);
            padding: 20px 40px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.5);
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 2px solid #e94560;
        }

        .header h1 {
            color: #00d4ff;
            font-size: 28px;
            text-shadow: 0 0 20px rgba(0, 212, 255, 0.5);
        }

        .header .logout-btn {
            background: linear-gradient(135deg, #e94560 0%, #c42847 100%);
            color: white;
            border: none;
            padding: 10px 25px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            font-weight: bold;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(233, 69, 96, 0.4);
        }

        .header .logout-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(233, 69, 96, 0.6);
        }

        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            padding: 30px 40px;
        }

        .stat-card {
            background: linear-gradient(135deg, #1e2a3a 0%, #2d3e50 100%);
            padding: 25px;
            border-radius: 15px;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.4);
            border-left: 4px solid #00d4ff;
            transition: all 0.3s ease;
        }

        .stat-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 12px 35px rgba(0, 212, 255, 0.3);
        }

        .stat-card h3 {
            color: #00d4ff;
            font-size: 16px;
            margin-bottom: 10px;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .stat-card .value {
            color: #ffffff;
            font-size: 36px;
            font-weight: bold;
            text-shadow: 0 0 15px rgba(255, 255, 255, 0.3);
        }

        .map-container {
            margin: 20px 40px;
            background: #1e2a3a;
            padding: 25px;
            border-radius: 15px;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.4);
        }

        .map-container h2 {
            color: #00d4ff;
            margin-bottom: 20px;
            font-size: 24px;
            text-shadow: 0 0 15px rgba(0, 212, 255, 0.4);
        }

        #map {
            height: 600px;
            border-radius: 10px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.5);
            filter: brightness(0.9) contrast(1.1);
        }

        .users-list {
            margin: 20px 40px;
            background: #1e2a3a;
            padding: 25px;
            border-radius: 15px;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.4);
        }

        .users-list h2 {
            color: #00d4ff;
            margin-bottom: 20px;
            font-size: 24px;
            text-shadow: 0 0 15px rgba(0, 212, 255, 0.4);
        }

        .user-card {
            background: linear-gradient(135deg, #2d3e50 0%, #1e2a3a 100%);
            padding: 20px;
            margin-bottom: 15px;
            border-radius: 10px;
            border-left: 3px solid #e94560;
            transition: all 0.3s ease;
        }

        .user-card:hover {
            transform: translateX(5px);
            box-shadow: 0 4px 20px rgba(233, 69, 96, 0.3);
        }

        .user-card .user-info {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-bottom: 10px;
        }

        .user-card .user-avatar {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            border: 2px solid #00d4ff;
            box-shadow: 0 0 15px rgba(0, 212, 255, 0.5);
        }

        .user-card .username {
            color: #00d4ff;
            font-weight: bold;
            font-size: 18px;
        }

        .user-card .address {
            color: #b8b8b8;
            margin: 8px 0;
            font-size: 14px;
        }

        .user-card .schedule {
            color: #e0e0e0;
            background: #16213e;
            padding: 12px;
            border-radius: 8px;
            margin-top: 10px;
            white-space: pre-wrap;
            font-size: 13px;
            border-left: 2px solid #e94560;
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: #00d4ff;
            font-size: 18px;
        }

        .spinner {
            border: 4px solid rgba(0, 212, 255, 0.1);
            border-top: 4px solid #00d4ff;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 20px auto;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .footer {
            text-align: center;
            padding: 30px;
            color: #7a7a7a;
            font-size: 14px;
            margin-top: 40px;
        }

        .footer a {
            color: #00d4ff;
            text-decoration: none;
            transition: all 0.3s ease;
        }

        .footer a:hover {
            color: #e94560;
            text-shadow: 0 0 10px rgba(233, 69, 96, 0.5);
        }

        /* –¢–µ–º–Ω–∞ —Ç–µ–º–∞ –¥–ª—è Leaflet –ø–æ–ø–∞–ø—ñ–≤ */
        .leaflet-popup-content-wrapper {
            background: #1e2a3a;
            color: #e0e0e0;
            border-radius: 10px;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.5);
        }

        .leaflet-popup-tip {
            background: #1e2a3a;
        }

        .leaflet-popup-content h3 {
            color: #00d4ff;
            margin-bottom: 10px;
        }

        .leaflet-popup-content p {
            color: #b8b8b8;
            margin: 5px 0;
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>‚ö° –ü–∞–Ω–µ–ª—å —É–ø—Ä–∞–≤–ª—ñ–Ω–Ω—è –±–æ—Ç–æ–º</h1>
        <a href="/logout"><button class="logout-btn">üö™ –í–∏–π—Ç–∏</button></a>
    </div>

    <div class="stats" id="stats">
        <div class="loading">
            <div class="spinner"></div>
            –ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏...
        </div>
    </div>

    <div class="map-container">
        <h2>üó∫Ô∏è –ö–∞—Ä—Ç–∞ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á—ñ–≤</h2>
        <div id="map"></div>
    </div>

    <div class="users-list">
        <h2>üë• –°–ø–∏—Å–æ–∫ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á—ñ–≤</h2>
        <div id="users">
            <div class="loading">
                <div class="spinner"></div>
                –ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á—ñ–≤...
            </div>
        </div>
    </div>

    <div class="footer">
        –ë–æ—Ç –∑—Ä–æ–±–ª–µ–Ω–æ –∑–∞–≤–¥—è–∫–∏ <a href="https://discord.gg/WVVDYc6uts" target="_blank">–≤—ñ—Ä—ñ –≤ –ø–µ–ª—å–º–µ–Ω—ñ ü•ü</a>
    </div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script>
        // –Ü–Ω—ñ—Ü—ñ–∞–ª—ñ–∑–∞—Ü—ñ—è –∫–∞—Ä—Ç–∏ –∑ —Ç–µ–º–Ω–æ—é —Ç–µ–º–æ—é
        const map = L.map('map').setView([50.4501, 30.5234], 6);

        // –í–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î–º–æ —Ç–µ–º–Ω—É —Ç–µ–º—É –¥–ª—è –∫–∞—Ä—Ç–∏
        L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', {
            attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors &copy; <a href="https://carto.com/attributions">CARTO</a>',
            subdomains: 'abcd',
            maxZoom: 20
        }).addTo(map);

        // –ö–∞—Å—Ç–æ–º–Ω–∞ —ñ–∫–æ–Ω–∫–∞ –¥–ª—è –º–∞—Ä–∫–µ—Ä—ñ–≤
        const customIcon = L.divIcon({
            className: 'custom-marker',
            html: '<div style="background: linear-gradient(135deg, #00d4ff 0%, #0099cc 100%); width: 30px; height: 30px; border-radius: 50%; border: 3px solid #e94560; box-shadow: 0 0 20px rgba(0, 212, 255, 0.8); display: flex; align-items: center; justify-content: center; color: white; font-weight: bold;">‚ö°</div>',
            iconSize: [30, 30],
            iconAnchor: [15, 15]
        });

        // –ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏
        fetch('/api/stats')
            .then(response => response.json())
            .then(data => {
                document.getElementById('stats').innerHTML = `
                    <div class="stat-card">
                        <h3>üë• –í—Å—å–æ–≥–æ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á—ñ–≤</h3>
                        <div class="value">${data.total_users}</div>
                    </div>
                    <div class="stat-card">
                        <h3>üìç –ó –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç–∞–º–∏</h3>
                        <div class="value">${data.users_with_coords}</div>
                    </div>
                    <div class="stat-card">
                        <h3>üîî –û—á—ñ–∫—É—é—Ç—å —Å–ø–æ–≤—ñ—â–µ–Ω–Ω—è</h3>
                        <div class="value">${data.pending_notifications}</div>
                    </div>
                `;
            })
            .catch(error => {
                console.error('–ü–æ–º–∏–ª–∫–∞ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏:', error);
                document.getElementById('stats').innerHTML = '<div class="loading" style="color: #e94560;">‚ùå –ü–æ–º–∏–ª–∫–∞ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏</div>';
            });

        // –ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á—ñ–≤
        fetch('/api/users')
            .then(response => response.json())
            .then(users => {
                // –î–æ–¥–∞—î–º–æ –º–∞—Ä–∫–µ—Ä–∏ –Ω–∞ –∫–∞—Ä—Ç—É
                users.forEach(user => {
                    const marker = L.marker([user.latitude, user.longitude], {icon: customIcon}).addTo(map);
                    marker.bindPopup(`
                        <h3>${user.username}</h3>
                        <p><strong>üìç –ê–¥—Ä–µ—Å–∞:</strong> ${user.city}, –≤—É–ª. ${user.street}, –±—É–¥. ${user.house}</p>
                        <p><strong>‚ö° –ì—Ä–∞—Ñ—ñ–∫:</strong></p>
                        <pre style="background: #16213e; padding: 10px; border-radius: 5px; max-width: 300px; overflow: auto; font-size: 12px;">${user.last_schedule || '–ù–µ–º–∞—î –¥–∞–Ω–∏—Ö'}</pre>
                    `);
                });

                // –í—ñ–¥–æ–±—Ä–∞–∂–µ–Ω–Ω—è —Å–ø–∏—Å–∫—É –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á—ñ–≤
                const usersHtml = users.map(user => `
                    <div class="user-card">
                        <div class="user-info">
                            ${user.avatar ? `<img src="${user.avatar}" class="user-avatar" alt="Avatar">` : '<div class="user-avatar" style="background: linear-gradient(135deg, #00d4ff, #0099cc); display: flex; align-items: center; justify-content: center; font-size: 24px;">üë§</div>'}
                            <div>
                                <div class="username">${user.username}</div>
                                <div class="address">üìç ${user.city}, –≤—É–ª. ${user.street}, –±—É–¥. ${user.house}</div>
                            </div>
                        </div>
                        <div class="schedule">
                            <strong>‚ö° –ì—Ä–∞—Ñ—ñ–∫ –≤—ñ–¥–∫–ª—é—á–µ–Ω—å:</strong><br>
                            ${user.last_schedule || '–ù–µ–º–∞—î –¥–∞–Ω–∏—Ö'}
                        </div>
                    </div>
                `).join('');

                document.getElementById('users').innerHTML = usersHtml || '<div class="loading" style="color: #7a7a7a;">–ö–æ—Ä–∏—Å—Ç—É–≤–∞—á—ñ–≤ –ø–æ–∫–∏ –Ω–µ–º–∞—î</div>';

                // –ê–≤—Ç–æ–º–∞—Ç–∏—á–Ω–µ –º–∞—Å—à—Ç–∞–±—É–≤–∞–Ω–Ω—è –∫–∞—Ä—Ç–∏
                if (users.length > 0) {
                    const bounds = L.latLngBounds(users.map(u => [u.latitude, u.longitude]));
                    map.fitBounds(bounds, { padding: [50, 50] });
                }
            })
            .catch(error => {
                console.error('–ü–æ–º–∏–ª–∫–∞ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á—ñ–≤:', error);
                document.getElementById('users').innerHTML = '<div class="loading" style="color: #e94560;">‚ùå –ü–æ–º–∏–ª–∫–∞ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á—ñ–≤</div>';
            });

        // –ê–≤—Ç–æ–æ–Ω–æ–≤–ª–µ–Ω–Ω—è –∫–æ–∂–Ω—ñ 30 —Å–µ–∫—É–Ω–¥
        setInterval(() => {
            location.reload();
        }, 30000);
    </script>
</body>
</html>